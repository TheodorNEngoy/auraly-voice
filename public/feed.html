<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Auraly — Feed</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script src="/auth.js" defer></script>
</head>
<body>
  <header class="top">
    <h1>🎙️ Auraly</h1>
    <nav>
      <a href="/index.html">Record</a>
      <a href="/feed.html" aria-current="page">Feed</a>
    </nav>
  </header>

  <main id="app"></main>

  <script>
    const app = document.getElementById('app');
    const esc = s => (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    async function loadFeed(){
      app.innerHTML = '<section class="card"><p>Loading…</p></section>';
      const res = await fetch('/api/feed?limit=20', { cache:'no-store' });
      const data = await res.json();
      app.innerHTML = '';
      for (const it of data.items){
        const a = it.author || {};
        const avatar = a.image_url ? esc(a.image_url) : '';
        const authorHtml = a.name ? `<div class="row" style="display:flex;align-items:center;gap:.5rem;">
            ${avatar ? `<img src="${avatar}" alt="" style="width:24px;height:24px;border-radius:50%">` : ''}
            <span class="muted">${esc(a.name)}</span>
          </div>` : '';

        const card = document.createElement('section');
        card.className = 'card';
        card.innerHTML = `
          <h3>${esc(it.title || 'Voice post')}</h3>
          ${authorHtml}
          <audio controls src="${it.playback}" style="width:100%"></audio>
          <p class="muted">${new Date(it.created_at).toLocaleString()}</p>
          <p>
            <a href="/p/${it.id}" target="_blank" rel="noopener">Share link</a>
            · <button class="x-trans" data-id="${it.id}">Transcribe</button>
          </p>
          <pre class="transcript">${esc(it.transcript || '')}</pre>
        `;
        app.appendChild(card);
      }

      document.querySelectorAll('.x-trans').forEach(btn=>{
        btn.onclick = async ()=>{
          btn.disabled = true; btn.textContent = 'Transcribing…';
          const id = btn.getAttribute('data-id');
          const r = await fetch(\`/api/transcribe?id=\${encodeURIComponent(id)}\`, { method:'POST' });
          const j = await r.json().catch(()=>({}));
          const pre = btn.closest('.card').querySelector('.transcript');
          if (r.ok && j.text){ pre.textContent = j.text; btn.textContent = 'Transcribed'; }
          else { pre.textContent = (j && j.error) ? JSON.stringify(j) : 'Failed'; btn.disabled = false; btn.textContent = 'Transcribe'; }
        };
      });
    }
    loadFeed();
  </script>
</body>
</html>
